async function sendMessage() {
    const inputField = document.getElementById('userInput');
    const text = inputField.value.trim();

    if (!text) return;

    addMessage(text, 'user');
    inputField.value = '';

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json'
                // نکته: در مرورگر نباید API Key را در Header بگذارید (CORS Error)
                // همان متد URL که استفاده کردیم برای مرورگر بهتر است
            },
            body: JSON.stringify({
                contents: [{ parts: [{ text: text }] }]
            })
        });

        const data = await response.json();

        if (data.error) {
            // نمایش خطای مستقیم از سمت گوگل
            addMessage("خطای گوگل: " + data.error.message, 'ai');
            return;
        }

        if (data.candidates && data.candidates[0].content) {
            const aiResponse = data.candidates[0].content.parts[0].text;
            addMessage(aiResponse, 'ai');
        } else {
            addMessage("پاسخی دریافت نشد. احتمالاً کلید API شما محدود شده است.", 'ai');
        }

    } catch (error) {
        // این بخش زمانی اجرا می‌شود که فیلترشکن شما وصل نباشد یا اینترنت مشکل داشته باشد
        addMessage("خطای شبکه: فیلترشکن را چک کنید یا کنسول را ببینید.", 'ai');
        console.error("Error Detail:", error);
    }
}


